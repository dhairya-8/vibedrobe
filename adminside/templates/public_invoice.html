{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Invoice - {{ order.order_number }}</title>
  
  <link rel="stylesheet" href="{% static 'admin/assets/libs/vanilla-datatables/vanilla-dataTables.min.css' %}" />
  <link href="{% static 'admin/assets/css/bootstrap.min.css' %}" rel="stylesheet" type="text/css" />
  <link href="{% static 'admin/assets/css/icons.min.css' %}" rel="stylesheet" type="text/css" />
  <link href="{% static 'admin/assets/css/app.min.css' %}" rel="stylesheet" type="text/css" />

  <style>
    body {
      background: #f5f5f5;
      padding: 30px;
      font-family: 'Roboto', Arial, sans-serif;
    }

    .invoice-wrapper {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }

    /* Header + Grand Total pink background */
    .invoice-header {
      background: #e8dff2; /* match your modal pink */
      border-radius: 10px 10px 0 0;
      padding: 20px;
    }

    .grand-total-row {
      background: #e8dff2 !important;
      color: #000 !important;
      font-weight: 600;
    }

    /* Table style */
    .table th, .table td {
      vertical-align: middle;
    }

    /* Print Fixes */
    @media print {
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }

      body * {
        visibility: hidden;
      }
      #printableInvoice, #printableInvoice * {
        visibility: visible;
      }
      #printableInvoice {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }

      /* Hide buttons */
      .no-print {
        display: none !important;
      }
          /* --- ADD THESE NEW STYLES --- */
    /* This creates a flex container for the address blocks */
    .address-container-print {
      display: flex !important;
      justify-content: space-between !important;
      width: 100% !important;
      align-items: flex-start !important; /* Aligns items to the top */
    }

    /* This styles the individual address columns */
    .address-column-print {
      width: 32% !important; /* A little less than 1/3 to prevent wrapping */
    }

    /* This stacks the items in the "Invoice to" block vertically */
    .invoice-to-block > * {
      display: block !important;
    }
    }
  </style>
</head>
<body>
  <div class="invoice-wrapper">

    <div class="card" id="printableInvoice">
      <!-- Header -->
      <div class="card-body invoice-header">
        <div class="row">
          <div class="col-4 align-self-center">
            <img src="{% static 'admin/assets/images/rbg2.png' %}" alt="logo-small" class="logo-sm me-1" height="70">
          </div>
          <div class="col-8 text-end align-self-center">
            <h5 class="mb-1 fw-semibold"><span class="text-muted">Invoice:</span> #{{ order.order_number }}</h5>
            <h5 class="mb-0 fw-semibold"><span class="text-muted">Issue Date:</span> {{ order.order_date|date:"d/m/Y" }}</h5>
          </div>
        </div>
      </div>

      <!-- Invoice Body -->
      <div class="card-body">
        <div class="row address-container-print">
          <div class="col-12 col-md-4 address-column-print invoice-to-block">
            <strong class="fs-14">Invoice To:</strong>
            <h5 class="my-1 fw-semibold fs-18">{{ address.full_name }}</h5>
            <p class="text-muted mb-0">@{{ order.user_id.username }} | +{{ address.phone }}</p>
          </div>
          <div class="col-12 col-md-4 address-column-print">
            <address class="fs-13">
              <strong class="fs-14">Billed To:</strong><br>
              {{ address.full_name }}<br>
              {{ address.address_line_1 }}{% if address.address_line_2 %}, {{ address.address_line_2 }}{% endif %}<br>
              {{ address.city }}, {{ address.state }} {{ address.pincode }}<br>
              <abbr title="Phone">P:</abbr> {{ address.phone }}
            </address>
          </div>
          <div class="col-12 col-md-4 address-column-print">
            <address class="fs-13">
              <strong class="fs-14">Shipped To:</strong><br>
              {{ address.full_name }}<br>
              {{ address.address_line_1 }}{% if address.address_line_2 %}, {{ address.address_line_2 }}{% endif %}<br>
              {{ address.city }}, {{ address.state }} {{ address.pincode }}<br>
              <abbr title="Phone">P:</abbr> {{ address.phone }}
            </address>
          </div>
        </div>

        <!-- Products Table -->
        <div class="row mt-3">
          <div class="col-lg-12">
            <div class="table-responsive project-invoice">
              <table class="table table-bordered mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Product</th>
                    <th style="text-align: center;">Qty</th>
                    <th style="text-align: right;">Rate (pre-GST)</th>
                    <th style="text-align: right;">GST</th>
                    <th style="text-align: right;">Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in order_items %}
                  <tr>
                    <td>
                      <h7 class="mt-0 mb-1 fs-14">{{ item.product_name }}</h7>
                      <p class="mb-0 text-muted fs-12">SKU: {{ item.product_sku }}</p>
                    </td>
                    <td style="text-align: center;">{{ item.quantity }}</td>
                    <td style="text-align: right;">₹{{ item.base_price|floatformat:2 }}</td>
                    <td style="text-align: right;">₹{{ item.total_gst_on_item|floatformat:2 }} ({{ item.gst_rate }}%)</td>
                    <td style="text-align: right;">₹{{ item.total_price|floatformat:2 }}</td>
                  </tr>
                  {% endfor %}
                  
                  <tr>
                    <td colspan="3" class="border-0"></td>
                    <td class="border-0 fs-14 text-dark text-end"><b>Sub Total (pre-GST)</b></td>
                    <td class="border-0 fs-14 text-dark text-end"><b>₹{{ subtotal_before_tax|floatformat:2 }}</b></td>
                  </tr>
                  <tr>
                    <td colspan="3" class="border-0"></td>
                    <td class="border-0 fs-14 text-dark text-end"><b>Total GST</b></td>
                    <td class="border-0 fs-14 text-dark text-end"><b>₹{{ total_gst|floatformat:2 }}</b></td>
                  </tr>
                  <tr>
                    <td colspan="3" class="border-0"></td>
                    <td class="border-0 fs-14 text-dark text-end"><b>Shipping Charges</b></td>
                    <td class="border-0 fs-14 text-dark text-end"><b>₹69.00</b></td>
                  </tr>
                  <tr class="grand-total-row">
                    <td colspan="3" class="border-0"></td>
                    <td class="border-0 fs-14 text-end"><b>Grand Total</b></td>
                    <td class="border-0 fs-14 text-end"><b>₹{{ order.total_amount|floatformat:2 }}</b></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Terms & Signature -->
        <div class="row mt-4">
          <div class="col-lg-6">
            <h5 class="mt-2">Terms And Condition :</h5>
            <ul class="ps-3">
              <li><small class="fs-12">All prices are inclusive of applicable GST.</small></li>
              <li><small class="fs-12">This is a system-generated invoice and does not require a signature.</small></li>
              <li><small class="fs-12">Refunds will be processed within 2-3 business days upon cancellation.</small></li>
            </ul>
          </div>
          <div class="col-lg-6 align-self-center">
            <div class="float-none float-md-end" style="width: 40%;">
              <small>Account Manager</small><br>
              <img src="{% static 'admin/assets/images/extra/sign.png' %}" alt="" class="mt-2 mb-1" height="24">
              <p class="border-top">Signature</p>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <hr>
        <div class="row d-flex justify-content-center">
          <div class="col-lg-12 col-xl-4 ms-auto align-self-center">
            <div class="text-center"><small class="fs-12">Thank you for your business!</small></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Buttons -->
    <div class="d-flex justify-content-end gap-2 mt-4 no-print">
      <button type="button" id="printInvoiceBtn" class="btn btn-success">
        <i class="bi bi-printer me-1"></i> Print / Save
      </button>
      <a href="/" class="btn btn-dark">Close</a>
    </div>

    <div id="email-status-message" class="mt-3"></div>
  </div>

  <script>
    document.getElementById("printInvoiceBtn").addEventListener("click", function () {
      window.print();
    });
  </script>
</body>
</html>
