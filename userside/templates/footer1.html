{% load static %}
<style>
  .footer-mobile {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1000; /* Ensures it's on top of other content */
    border-top: 1px solid #eee;
    padding-top: 8px;
    padding-bottom: 8px;
}
</style>
<div class="mb-5 pb-xl-5"></div>

<!-- Main Footer -->
<footer class="footer footer_type_1">
  <div class="footer-middle container">
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-5">
      <!-- Store Info -->
      <div class="footer-column footer-store-info mb-4 mb-lg-0">
        <div class="logo">
          <a href="../index.html">
            <img src="{% static 'user/assets/images/VB_logo1.png' %}" width="230" alt="Uomo" class="logo__image d-block">
          </a>
        </div>
        <p class="footer-address">CG Road, Ahmedabad, India</p>
        <p class="m-0">
          <strong class="fw-medium">info.vibedrobe@gmail.com</strong>
        </p>
        <p>
          <strong class="fw-medium">+91 98119 22936</strong>
        </p>
      </div>

      <!-- Company Links -->
      <div class="footer-column footer-menu mb-4 mb-lg-0">
        <h5 class="sub-menu__title text-uppercase">Company</h5>
        <ul class="sub-menu__list list-unstyled">
          <li class="sub-menu__item">
            <a href="{% url 'aboutus' %}" class="menu-link menu-link_us-s">About Us</a>
          </li>
          <li class="sub-menu__item">
            <a href="{% url 'contactus' %}" class="menu-link menu-link_us-s">Contact Us</a>
          </li>
        </ul>
      </div>

      <!-- Shop Links -->
      <div class="footer-column footer-menu mb-4 mb-lg-0">
        <h5 class="sub-menu__title text-uppercase">Shop</h5>
        <ul class="sub-menu__list list-unstyled">
          <li class="sub-menu__item">
            <a href="{% url 'shop' %}?sort=date-new" class="menu-link menu-link_us-s">New Arrivals</a>
          </li>
          <li class="sub-menu__item">
            <a href="{% url 'shop' %}?gender=Male" class="menu-link menu-link_us-s">Men</a>
          </li>
          <li class="sub-menu__item">
            <a href="{% url 'shop' %}?gender=Female" class="menu-link menu-link_us-s">Women</a>
          </li>
          <li class="sub-menu__item">
            <a href="{% url 'shop' %}" class="menu-link menu-link_us-s">Shop All</a>
          </li>
        </ul>
      </div>

      <!-- Help Links -->
      <div class="footer-column footer-menu mb-4 mb-lg-0">
        <h5 class="sub-menu__title text-uppercase">Help</h5>
        <ul class="sub-menu__list list-unstyled">
          <li class="sub-menu__item">
            <a href="{% url 'account_dashboard' %}" class="menu-link menu-link_us-s">My Account</a>
          </li>
          <li class="sub-menu__item">
            <a href="{% url 'contactus' %}" class="menu-link menu-link_us-s">Contact</a>
          </li>
        </ul>
      </div>

      <!-- Payment Options -->
      <div class="footer-column footer-menu mb-4 mb-lg-0">
        <div class="mt-4 pt-3">
          <strong class="fw-medium">Secure payments</strong>
          <p class="mt-2">
            <img loading="lazy" src="{% static 'user/assets/images/payment-options.png' %}" alt="Acceptable payment gateways" class="mw-100">
          </p>
        </div>
      </div>

    </div> <!-- /.row -->
  </div> <!-- /.footer-middle container -->
</footer>

<!-- Mobile Fixed Footer -->
<footer class="footer-mobile container w-100 px-3 d-md-none bg-body">
  <div class="row text-center">
    <div class="col-3">
      <a href="{% url 'homepage' %}" class="footer-mobile__link d-flex flex-column align-items-center">
        <svg class="d-block" width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"><use href="#icon_home" /></svg>
        <span>Home</span>
      </a>
    </div>
    <div class="col-3">
      <a href="{% url 'shop' %}" class="footer-mobile__link d-flex flex-column align-items-center">
        <svg class="d-block" width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"><use href="#icon_hanger" /></svg>
        <span>Shop</span>
      </a>
    </div>
    <div class="col-3">
      <a href="{% url 'wishlist' %}" class="footer-mobile__link d-flex flex-column align-items-center">
        <div class="position-relative">
          <svg class="d-block" width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><use href="#icon_heart" /></svg>
          {% if wishlist_count > 0 %}
            <span class="wishlist-amount d-block position-absolute js-wishlist-count">{{ wishlist_count }}</span>
          {% endif %}
        </div>
        <span>Wishlist</span>
      </a>
    </div>
    <div class="col-3">
      <a href="{% url 'account_dashboard' %}" class="footer-mobile__link d-flex flex-column align-items-center">
        <svg class="d-block" width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><use href="#icon_user" /></svg>
        <span>Account</span>
      </a>
    </div>
  </div>
</footer>

<style>
  /* Custom Dialog Styles for Cart Drawer */
.custom-dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1100; /* Higher than cart drawer z-index */
}

.custom-dialog {
    background: white;
    padding: 20px;
    border-radius: 8px;
    max-width: 400px;
    width: 90%;
    z-index: 1101;
}

.custom-dialog h4 {
    margin-bottom: 20px;
    font-weight: 500;
}

.dialog-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.dialog-buttons button {
    width: 100%;
    padding: 10px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-danger {
    background: #dc3545;
    color: white;
    border: none;
}

.btn-outline-secondary {
    background: white;
    border: 1px solid #6c757d;
    color: #6c757d;
}

.btn-link {
    background: transparent;
    border: none;
    color: #007bff;
    text-decoration: underline;
}
</style>

<!-- Cart Drawer -->
<div class="aside aside_right overflow-hidden cart-drawer" id="cartDrawer" data-item-count="{{ cart_drawer_data.cart_items_count }}">
    
    <!-- Header -->
    <div class="aside-header d-flex align-items-center">
        <h3 class="text-uppercase fs-6 mb-0">
            SHOPPING BAG (
            <span class="cart-amount js-cart-items-count">
                {{ cart_drawer_data.cart_items_count }}
            </span>
            )
        </h3>
        <button class="btn-close-lg js-close-aside btn-close-aside ms-auto"></button>
    </div>
    <!-- /.aside-header -->

    <!-- Cart Items -->
    <div class="aside-content cart-drawer-items-list">
        {% for item in cart_drawer_data.cart_items %}
        <div class="cart-drawer-item d-flex position-relative">
            
            <!-- Product Image -->
            <div class="position-relative">
                <img loading="lazy" class="cart-drawer-item__img"
                     src="{{ item.image }}" alt="{{ item.name|truncatechars:30 }}"
                     style="width:70px; height:100px; object-fit:cover;">
            </div>

            <!-- Product Info -->
            <div class="cart-drawer-item__info flex-grow-1">
                <h6 class="cart-drawer-item__title fw-normal">{{ item.name|truncatechars:30 }}</h6>
                <p class="cart-drawer-item__option text-secondary">
                    Color: {{ item.color }}
                </p>
                <p class="cart-drawer-item__option text-secondary">
                    Size: {{ item.size }}
                </p>

                <!-- Quantity & Price -->
<div class="d-flex align-items-center justify-content-between mt-1">
    <form method="POST" action="{% url 'update_cart_item_drawer' %}" class="update-cart-form">
        {% csrf_token %}
        <input type="hidden" name="cart_item_id" value="{{ item.id }}">

        <div class="qty-control position-relative">
            <input type="number" name="quantity" value="{{ item.quantity }}" min="1"
                   class="qty-control__number border-0 text-center" data-item-id="{{ item.id }}">
            <div class="qty-control__reduce">-</div>
            <div class="qty-control__increase">+</div>
        </div>
    </form>

    <span class="cart-drawer-item__price money price">
        ₹{{ item.total_price }}
    </span>
</div>
                <div class="update-error text-danger small mt-1" style="display:none;"></div>
            </div>

            <!-- Remove Item -->
            <a href="{{ item.remove_url }}" class="btn-close-xs position-absolute top-0 end-0 js-remove-item" data-item-id="{{ item.id }}" data-product-name="{{ item.name|truncatechars:30 }}"></a>
        </div>

        {% if not forloop.last %}
            <hr class="cart-drawer-divider">
        {% endif %}
        {% empty %}
        <div class="text-center py-4">
            <p>Your cart is empty</p>
            <a href="{% url 'shop' %}" class="btn btn-primary">Continue Shopping</a>
        </div>
        {% endfor %}
    </div>
    <!-- /.aside-content -->

    {% if cart_drawer_data.cart_items %}
    <!-- Cart Actions -->
    <div class="cart-drawer-actions position-absolute start-0 bottom-0 w-100">
        <hr class="cart-drawer-divider">

        <div class="d-flex justify-content-between">
            <h6 class="fs-base fw-medium">SUBTOTAL:</h6>
            <span class="cart-subtotal fw-medium">
                ₹{{ cart_drawer_data.cart_subtotal|floatformat:2 }}
            </span>
        </div>

        <a href="{% url 'cart' %}" class="btn btn-light mt-3 d-block">View Cart</a>
        <a href="{% url 'checkout' %}" class="btn btn-primary mt-3 d-block">Checkout</a>
    </div>
    <!-- /.cart-drawer-actions -->
    {% endif %}
</div>

<!-- Scroll To Top -->
<div id="scrollTop" class="visually-hidden end-0"></div>

<!-- Page Overlay -->
<div class="page-overlay"></div>

<script>
  $(document).ready(function() {
    // Check if cart drawer should be opened on page load
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('open_cart_drawer') === 'true') {
        // Open the cart drawer using existing theme methods
        openCartDrawer();
        
        // Clean up URL
        const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
    }
    
    // Store the scroll position and active item before form submission
    let cartScrollPosition = 0;
    let activeItemId = null;
    
    // Function to open cart drawer
    function openCartDrawer() {
        $('#cartDrawer').addClass('aside_visible');
        $('.page-overlay').addClass('page-overlay_visible');
        $('body').addClass('overflow-hidden');
    }
    
    // Custom confirmation dialog function
    function showConfirmationDialog(productName, callback) {
        const dialog = `
            <div class="custom-dialog-overlay">
                <div class="custom-dialog">
                    <h4>Are you sure you want to remove ${productName}?</h4>
                    <div class="dialog-buttons">
                        <button class="btn btn-danger confirm-remove">Yes, Remove</button>
                        <button class="btn btn-outline-secondary move-to-wishlist">Move to Wishlist</button>
                        <button class="btn btn-link cancel-dialog">Cancel</button>
                    </div>
                </div>
            </div>
        `;
        $('body').append(dialog);
    
        $('.confirm-remove').on('click', function() {
            callback(true);
            $('.custom-dialog-overlay').remove();
        });
    
        $('.move-to-wishlist').on('click', function() {
            callback(false, true);
            $('.custom-dialog-overlay').remove();
        });
    
        $('.cancel-dialog').on('click', function() {
            $('.custom-dialog-overlay').remove();
        });
    }
    
    // Handle remove item - show confirmation dialog
    $(document).on('click', '.js-remove-item', function(e) {
        e.preventDefault();
        
        const productName = $(this).data('product-name');
        const removeUrl = $(this).attr('href');
        const itemId = $(this).data('item-id');
        
        showConfirmationDialog(productName, function(remove, moveToWishlist) {
            if (remove) {
                // Add parameter to keep drawer open
                let finalRemoveUrl = removeUrl;
                if (finalRemoveUrl.includes('?')) {
                    finalRemoveUrl += '&open_cart_drawer=true';
                } else {
                    finalRemoveUrl += '?open_cart_drawer=true';
                }
                
                window.location.href = finalRemoveUrl;
            } else if (moveToWishlist) {
                // Redirect to move to wishlist URL
                window.location.href = `/move-to-wishlist/${itemId}/?open_cart_drawer=true`;
            }
        });
    });
    
    // Replace theme's quantity controls with our own
    function replaceQuantityControls() {
        $('.cart-drawer .qty-control').each(function() {
            const $control = $(this);
            const $input = $control.find('input[name="quantity"]');
            const currentValue = parseInt($input.val()) || 1;
            
            // Create our own control structure
            const newControl = `
                <div class="qty-control position-relative" style="display: inline-block;">
                    <input type="number" name="quantity" value="${currentValue}" min="1" 
                           class="qty-control__number border-0 text-center" style="width: 50px;" data-item-id="${$input.data('item-id')}">
                    <div class="qty-control__reduce" style="position: absolute; left: 0; top: 0; cursor: pointer; width: 20px; text-align: center;">-</div>
                    <div class="qty-control__increase" style="position: absolute; right: 0; top: 0; cursor: pointer; width: 20px; text-align: center;">+</div>
                </div>
            `;
            
            // Replace the control
            $control.replaceWith(newControl);
        });
        
        // Set up event handlers for our new controls
        $(document).off('click', '.cart-drawer .qty-control__increase, .cart-drawer .qty-control__reduce').on('click', '.cart-drawer .qty-control__increase, .cart-drawer .qty-control__reduce', function(e) {
            e.preventDefault();
            e.stopImmediatePropagation();
            
            const $form = $(this).closest('form');
            const $input = $form.find('input[name="quantity"]');
            let currentQty = parseInt($input.val()) || 1;
            const itemId = $input.data('item-id');
            const productName = $(this).closest('.cart-drawer-item').find('.cart-drawer-item__title').text();
            
            if ($(this).hasClass('qty-control__increase')) {
                currentQty += 1;
                // Update the input value
                $input.val(currentQty);
                
                // Store which item is being updated
                activeItemId = $form.find('input[name="cart_item_id"]').val();
                
                // Store scroll position
                cartScrollPosition = $('.cart-drawer-items-list').scrollTop();
                
                // Add hidden input to keep drawer open
                $form.find('input[name="keep_drawer_open"]').remove();
                $form.append('<input type="hidden" name="keep_drawer_open" value="true">');
                
                // Submit the form
                $form.submit();
            } else if ($(this).hasClass('qty-control__reduce')) {
                if (currentQty > 1) {
                    currentQty -= 1;
                    // Update the input value
                    $input.val(currentQty);
                    
                    // Store which item is being updated
                    activeItemId = $form.find('input[name="cart_item_id"]').val();
                    
                    // Store scroll position
                    cartScrollPosition = $('.cart-drawer-items-list').scrollTop();
                    
                    // Add hidden input to keep drawer open
                    $form.find('input[name="keep_drawer_open"]').remove();
                    $form.append('<input type="hidden" name="keep_drawer_open" value="true">');
                    
                    // Submit the form
                    $form.submit();
                } else {
                    // Quantity is 1, show confirmation dialog
                    const removeUrl = $(this).closest('.cart-drawer-item').find('.js-remove-item').attr('href');
                    
                    showConfirmationDialog(productName, function(remove, moveToWishlist) {
                        if (remove) {
                            // Add parameter to keep drawer open
                            let finalRemoveUrl = removeUrl;
                            if (finalRemoveUrl.includes('?')) {
                                finalRemoveUrl += '&open_cart_drawer=true';
                            } else {
                                finalRemoveUrl += '?open_cart_drawer=true';
                            }
                            
                            window.location.href = finalRemoveUrl;
                        } else if (moveToWishlist) {
                            // Redirect to move to wishlist URL
                            window.location.href = `/move-to-wishlist/${itemId}/?open_cart_drawer=true`;
                        }
                    });
                }
            }
        });
        
        // Handle direct input changes
        $(document).off('change', '.cart-drawer input[name="quantity"]').on('change', '.cart-drawer input[name="quantity"]', function(e) {
            e.stopImmediatePropagation();
            
            const $form = $(this).closest('form');
            let quantity = parseInt($(this).val()) || 1;
            
            if (quantity < 1) {
                quantity = 1;
                $(this).val(1);
            }
            
            // Store which item is being updated
            activeItemId = $form.find('input[name="cart_item_id"]').val();
            
            // Store scroll position
            cartScrollPosition = $('.cart-drawer-items-list').scrollTop();
            
            // Add hidden input to keep drawer open
            $form.find('input[name="keep_drawer_open"]').remove();
            $form.append('<input type="hidden" name="keep_drawer_open" value="true">');
            
            // Submit form
            $form.submit();
        });
    }
    
    // Initialize when page loads
    setTimeout(function() {
        replaceQuantityControls();
        
        // If we have a stored scroll position, restore it
        if (cartScrollPosition > 0) {
            $('.cart-drawer-items-list').scrollTop(cartScrollPosition);
        }
        
        // If we have an active item ID, highlight it briefly
        if (activeItemId) {
            const $activeItem = $(`.cart-drawer-item input[value="${activeItemId}"]`).closest('.cart-drawer-item');
            $activeItem.addClass('highlight-update');
            setTimeout(() => {
                $activeItem.removeClass('highlight-update');
            }, 1000);
        }
    }, 100);
    
    // Also check periodically in case of dynamic content loading
    setInterval(function() {
        if ($('#cartDrawer').hasClass('aside_visible')) {
            replaceQuantityControls();
        }
    }, 1000);
});
</script>