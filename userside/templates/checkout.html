{% extends 'base1.html' %}
{% load static %}
{% block title %}
  Checkout | VibeDrobe
{% endblock %}

{% block css %}
  <!-- Stylesheets -->
  <link rel="stylesheet" href="{% static 'user/assets/css/plugins/swiper.min.css' %}" type="text/css" />
  <link rel="stylesheet" href="{% static 'user/assets/css/plugins/jquery.fancybox.css' %}" type="text/css" />
  <link rel="stylesheet" href="{% static 'user/assets/css/style.css' %}" type="text/css" />

  <style>
    /* Elegant Address Cards */
    .address-card {
      border: 1px solid #e8e8e8;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
      position: relative;
    }
    
    .address-card:hover {
      border-color: #d4af37;
      box-shadow: 0 5px 25px rgba(212, 175, 55, 0.1);
      transform: translateY(-2px);
    }
    
    .address-card.selected {
      border-color: #d4af37;
      background: linear-gradient(135deg, #fffaf0 0%, #fffdf5 100%);
      box-shadow: 0 5px 25px rgba(212, 175, 55, 0.15);
    }
    
    .address-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #d4af37, #f8e597);
      border-radius: 12px 12px 0 0;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .address-card.selected::before {
      opacity: 1;
    }
    
    .address-type {
      font-size: 12px;
      color: #d4af37;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    .address-name {
      font-size: 16px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .default-badge {
      background: linear-gradient(135deg, #d4af37, #f8e597);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .address-details {
      color: #7f8c8d;
      line-height: 1.6;
    }
    
    .address-details p {
      margin-bottom: 6px;
    }
    
    /* Add Address Button */
    .add-address-btn {
      border: 2px dashed #e8e8e8;
      border-radius: 12px;
      padding: 25px;
      text-align: center;
      background: #fafafa;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .add-address-btn:hover {
      border-color: #d4af37;
      background: linear-gradient(135deg, #fffaf0 0%, #fffdf5 100%);
    }
    
    .add-address-btn i {
      font-size: 24px;
      color: #d4af37;
      margin-bottom: 10px;
    }
    
    .add-address-btn span {
      display: block;
      color: #d4af37;
      font-weight: 600;
      font-size: 14px;
    }
    
    /* Payment Methods */
    .payment-section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-top: 30px;
      border: 1px solid #e8e8e8;
    }
    
    .payment-section-title {
      font-size: 18px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #f1f1f1;
    }
    
    .payment-method-card {
      border: 1px solid #e8e8e8;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
    }
    
    .payment-method-card:hover {
      border-color: #d4af37;
      box-shadow: 0 5px 20px rgba(212, 175, 55, 0.1);
    }
    
    .payment-method-card.selected {
      border-color: #d4af37;
      background: linear-gradient(135deg, #fffaf0 0%, #fffdf5 100%);
    }
    
    .payment-method-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .payment-method-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: linear-gradient(135deg, #d4af37, #f8e597);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
    }
    
    .payment-method-icon i {
      color: white;
      font-size: 18px;
    }
    
    .payment-method-title {
      font-size: 16px;
      font-weight: 600;
      color: #2c3e50;
    }
    
    .payment-method-description {
      color: #7f8c8d;
      font-size: 14px;
      line-height: 1.5;
      padding-left: 55px;
    }
    
    .coming-soon {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 11px;
      color: #6c757d;
      display: inline-block;
      margin-left: 10px;
      font-weight: 500;
    }
    
    /* Section Headers */
    .section-header {
      font-size: 20px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f1f1f1;
      position: relative;
    }
    
    .section-header::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 60px;
      height: 2px;
      background: linear-gradient(90deg, #d4af37, #f8e597);
    }
    
    /* Luxury Enhancements */
    .luxury-divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, #e8e8e8, transparent);
      margin: 30px 0;
    }
    
    .btn-checkout {
      background: linear-gradient(135deg, #d4af37, #f8e597);
      border: none;
      border-radius: 8px;
      padding: 15px 30px;
      font-weight: 600;
      font-size: 16px;
      color: white;
      transition: all 0.3s ease;
      width: 100%;
    }
    
    .btn-checkout:hover {
      background: linear-gradient(135deg, #c19b2e, #e6d285);
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(212, 175, 55, 0.3);
    }
  </style>
  
{% endblock %}
{% block content %}

<main>
   <div class="mb-4 pb-4"></div>
   <section class="shop-checkout container">
     <h2 class="page-title">Shipping and Checkout</h2>
     <div class="checkout-steps">
       <a href="{% url 'cart' %}" class="checkout-steps__item active">
         <span class="checkout-steps__item-number">01</span>
         <span class="checkout-steps__item-title">
           <span>Shopping Bag</span>
           <em>Manage Your Items List</em>
         </span>
       </a>
       <a href="{% url 'checkout' %}" class="checkout-steps__item active">
         <span class="checkout-steps__item-number">02</span>
         <span class="checkout-steps__item-title">
           <span>Shipping and Checkout</span>
           <em>Checkout Your Items List</em>
         </span>
       </a>
       <a href="#" class="checkout-steps__item">
         <span class="checkout-steps__item-number">03</span>
         <span class="checkout-steps__item-title">
           <span>Confirmation</span>
           <em>Review And Submit Your Order</em>
         </span>
       </a>
     </div>
     
     <form method="POST" action="{% url 'checkout' %}" id="checkoutForm" 
      class="triggers-loader" 
      data-loader-text="Placing your order, please wait...">
       {% csrf_token %}
       <div class="checkout-form">
         <div class="billing-info__wrapper">
           <!-- Shipping Address Section -->
           <div class="section-header">Shipping Address</div>
           
           <div class="address-selection mb-5">
             {% if user_addresses %}
               <div class="row">
                 {% for address in user_addresses %}
                 <div class="col-md-6">
                   <div class="address-card" data-address-id="{{ address.id }}">
                     <div class="address-type">{{ address.get_address_type_display }}</div>
                     <div class="address-name">
                       {{ address.address_name }}
                       {% if address.is_default %}<span class="default-badge">Default</span>{% endif %}
                     </div>
                     <div class="address-details">
                       <p><strong>{{ address.full_name }}</strong></p>
                       <p>{{ address.address_line_1 }}</p>
                       {% if address.address_line_2 %}
                         <p>{{ address.address_line_2 }}</p>
                       {% endif %}
                       <p>{{ address.city }}, {{ address.state }} - {{ address.pincode }}</p>
                       <p>ðŸ“ž {{ address.phone }}</p>
                     </div>
                     <input type="radio" name="address_id" value="{{ address.id }}" 
                            {% if address.is_default %}checked{% endif %} 
                            style="display: none;">
                   </div>
                 </div>
                 {% endfor %}
                 
                 <!-- Add New Address Button -->
                 <div class="col-md-6">
                   <div class="add-address-btn" onclick="window.location.href='{% url 'add_address' %}#addresses'">
                     <i class="fas fa-plus-circle"></i>
                     <span>Add New Address</span>
                     <p style="color: #95a5a6; font-size: 13px; margin-top: 8px;">Manage your addresses in account settings</p>
                   </div>
                 </div>
               </div>
             {% else %}
               <!-- No addresses case -->
               <div class="text-center py-5">
                 <i class="fas fa-map-marker-alt" style="font-size: 48px; color: #bdc3c7; margin-bottom: 20px;"></i>
                 <h4 style="color: #7f8c8d; margin-bottom: 15px;">No addresses found</h4>
                 <p style="color: #95a5a6; margin-bottom: 25px;">Please add a shipping address to continue with your order</p>
                 <button type="button" class="btn btn-primary" onclick="window.location.href='{% url 'account_addresses' %}#addresses'">
                   <i class="fas fa-plus me-2"></i>Add Address
                 </button>
               </div>
             {% endif %}
           </div>
           
           <div class="luxury-divider"></div>
           
           <!-- Payment Method Section -->
           <div class="payment-section">
             <div class="payment-section-title">Payment Method</div>
             
             <div class="payment-method-card selected" data-method="cod">
               <div class="payment-method-header">
                 <div class="payment-method-icon">
                   <i class="fas fa-money-bill-wave"></i>
                 </div>
                 <div class="form-check" style="flex-grow: 1; margin: 0;">
                   <input class="form-check-input form-check-input_fill" type="radio" name="payment_method" id="checkout_payment_method_3" value="cod" checked>
                   <label class="form-check-label payment-method-title" for="checkout_payment_method_3">
                     Cash on Delivery
                   </label>
                 </div>
               </div>
               <div class="payment-method-description">
                 Pay with cash when your order is delivered. Please use your Order ID as the payment reference.
               </div>
             </div>
             
<div class="payment-method-card" data-method="online">
  <div class="payment-method-header">
    <div class="payment-method-icon">
      <i class="fas fa-credit-card"></i>
    </div>
    <div class="form-check" style="flex-grow: 1; margin: 0;">
      <input class="form-check-input form-check-input_fill" type="radio" name="payment_method" id="checkout_payment_method_1" value="online">
      <label class="form-check-label payment-method-title" for="checkout_payment_method_1">
        Online Payment (Card)
      </label>
    </div>
  </div>
  <div class="payment-method-description">
    Pay securely using Credit/Debit card. Please use your Order ID as the payment reference.
  </div>
</div>

<div class="payment-method-card" data-method="upi">
  <div class="payment-method-header">
    <div class="payment-method-icon">
      <i class="fas fa-mobile-alt"></i>
    </div>
    <div class="form-check" style="flex-grow: 1; margin: 0;">
      <input class="form-check-input form-check-input_fill" type="radio" name="payment_method" id="checkout_payment_method_2" value="upi">
      <label class="form-check-label payment-method-title" for="checkout_payment_method_2">
        UPI Payment
      </label>
    </div>
  </div>
  <div class="payment-method-description">
    Pay instantly using any UPI app. Please use your Order ID as the payment reference.
  </div>
</div>
           </div>
           
           <div class="policy-text mt-4" style="color: #95a5a6; font-size: 13px;">
             Your personal data will be used to process your order, support your experience throughout this website, and for other purposes described in our <a href="terms.html" target="_blank" style="color: #d4af37;">privacy policy</a>.
           </div>
         </div>
         
         <!-- Order Summary Section -->
         <div class="checkout__totals-wrapper">
           <div class="sticky-content">
             <div class="checkout__totals">
               <h3>Your Order</h3>
               <table class="checkout-cart-items">
                 <thead>
                   <tr>
                     <th>PRODUCT</th>
                     <th>SUBTOTAL</th>
                   </tr>
                 </thead>
                 <tbody>
                   {% for item in cart_items %}
                   <tr>
                     <td>
                       {{ item.product_variant_id.product_id.name|truncatechars:20 }} x {{ item.quantity }}
                       <br>
                       <small>Size: {{ item.product_variant_id.size_id.name }}</small>
                     </td>
                     <td>
                       â‚¹{{ item.total_price|floatformat:2 }}
                     </td>
                   </tr>
                   {% endfor %}
                 </tbody>
               </table>
               <table class="checkout-totals">
                 <tbody>
                   <tr>
                     <th>SUBTOTAL (Before GST)</th>
                     <td>â‚¹{{ base_price_total|floatformat:2 }}</td>
                   </tr>

                   <tr>
                     <th>GST</th>
                     <td>â‚¹{{ total_gst|floatformat:2 }}</td>
                   </tr>

                   <tr>
                     <th>SHIPPING</th>
                     <td>â‚¹{{ shipping_charge|floatformat:2 }}</td>
                   </tr>
                  
                   <tr>
                     <th>TOTAL</th>
                     <td>â‚¹{{ grand_total|floatformat:2 }}</td>
                   </tr>
                 </tbody>
               </table>
             </div>
             
             <button type="submit" class="btn btn-checkout">
               <i class="fas fa-lock me-2"></i>PLACE ORDER
             </button>
           </div>
         </div>
       </div>
     </form>
   </section>
 </main>
{% endblock %}

{% block script %}
  <script src="{% static 'user/assets/js/plugins/jquery.min.js' %}"></script>
  <script src="{% static 'user/assets/js/plugins/bootstrap.bundle.min.js' %}"></script>
  <script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>

<script>
    $(document).ready(function() {
      // Address selection
      $('.address-card').on('click', function() {
        $('.address-card').removeClass('selected');
        $(this).addClass('selected');
        $(this).find('input[type="radio"]').prop('checked', true);
      });
      
      // Payment method selection
      $('.payment-method-card').on('click', function() {
        $('.payment-method-card').removeClass('selected');
        $(this).addClass('selected');
        $(this).find('input[type="radio"]').prop('checked', true);
      });
      
      // âœ¨ UPDATED Form validation and loader trigger âœ¨
      $('#checkoutForm').on('submit', function(e) {
        // Check if at least one address is selected
        const selectedAddress = $('input[name="address_id"]:checked').val();
        if (!selectedAddress) {
          e.preventDefault(); // This stops the form from submitting
          alert('Please select a shipping address.');
          return; // Exit
        }
        
       

        // The form will now submit to your backend.
      });
    });
  </script>
{% endblock %}